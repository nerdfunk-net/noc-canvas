# Canvas Load Icon Fix

## Issue Description

When loading a saved canvas, devices were displayed with the **default template icon** (based on `device_type` like "router", "switch", etc.) instead of the **correct template icon** (based on `platform_id` and `device_type_model` from Nautobot).

However, when **dragging and dropping** the same device from the inventory, the correct template icon was displayed.

## Root Cause Analysis

### How Device Icons Work

1. **Device Properties Storage**: When a device is dropped from Nautobot inventory, its properties are stored as a JSON string containing:
   - `platform_id`: The Nautobot platform ID
   - `device_type_model`: The specific device model (e.g., "ASR1001-X")
   - Other metadata (location, role, status, etc.)

2. **Icon Loading Process**:
   - `getDeviceIcon()` checks a cached map: `deviceIconMap`
   - If not cached, returns the hardcoded icon for immediate rendering
   - `loadDeviceIconFromTemplate()` runs asynchronously to load the correct template icon
   - Template service queries the backend for SVG icon based on `platform_id` or `device_type_model`
   - Once loaded, the icon is cached in `deviceIconMap` by device ID

3. **Watcher Mechanism**:
   ```typescript
   watch(() => deviceStore.devices, async (devices) => {
     for (const device of devices) {
       if (!deviceIconMap.value.has(device.id)) {
         await loadDeviceIconFromTemplate(device)
       }
     }
   }, { deep: true, immediate: true })
   ```

### The Problem

When loading a canvas:

1. `loadCanvasById()` is called
2. `deviceStore.clearDevices()` clears the devices array
3. **BUT** `deviceIconMap` in `NOCCanvas.vue` is **NOT** cleared
4. New devices are loaded from the saved canvas file
5. The watcher triggers for each device
6. **Critical Issue**: The watcher checks `if (!deviceIconMap.value.has(device.id))`
7. If a device ID from the loaded canvas matches an ID from a previous session (highly likely since IDs are persistent), the watcher **skips** loading the icon
8. The device continues to use whatever icon was cached, or falls back to the default hardcoded icon

### Why Drag-and-Drop Works

When dragging and dropping:
- New devices get **new IDs** generated by `generateDeviceId()`
- These IDs are guaranteed to be unique and not in the cache
- The watcher always loads the template icon because the ID is not in `deviceIconMap`

## The Fix

### Changes Made

**File**: `frontend/src/components/NOCCanvas.vue`

Added logic to clear the `deviceIconMap` when the devices array is emptied:

```typescript
// Watch for device changes and load template icons
watch(() => deviceStore.devices, async (devices) => {
  // If devices array is empty, clear the icon map
  if (devices.length === 0) {
    console.log('üßπ Clearing device icon map (devices cleared)')
    deviceIconMap.value = new Map()
    return
  }

  // Load icons for new devices
  for (const device of devices) {
    if (!deviceIconMap.value.has(device.id)) {
      await loadDeviceIconFromTemplate(device)
    }
  }
}, { deep: true, immediate: true })
```

### Improved Logging

Enhanced the `loadDeviceIconFromTemplate()` function with better debug output:

```typescript
// If we have platform or device type info, try to get icon from template service
if (platformId || deviceTypeModel) {
  const templateIcon = await templateService.getDeviceIcon(platformId, deviceTypeModel)
  if (templateIcon) {
    console.log('‚úÖ Using template icon for device:', device.name, 'from platform:', platformId, 'or model:', deviceTypeModel)
    // ... cache the icon
    return
  } else {
    console.log('‚ö†Ô∏è No template icon found for device:', device.name, 'platform:', platformId, 'model:', deviceTypeModel)
  }
} else {
  console.log('‚ö†Ô∏è No platform_id or device_type_model in device properties for:', device.name)
}

// Use hardcoded icon as fallback
console.log('üîÑ Using fallback hardcoded icon for device:', device.name, 'type:', device.device_type)
```

### Debug Logging in Canvas Loader

**File**: `frontend/src/composables/useCanvasState.ts`

Added debugging to inspect device properties when loading:

```typescript
console.log('üîç DEBUG: Devices being loaded from canvas:', devicesWithCorrectTypes.map(d => ({
  id: d.id,
  name: d.name,
  properties: d.properties,
  parsedProperties: d.properties ? JSON.parse(d.properties) : null
})))
```

## Testing the Fix

### Test Scenario 1: Load Canvas with Template Icons
1. Drag a device from Nautobot inventory (e.g., Cisco ASR router)
2. Verify it shows the correct Cisco icon (not generic router icon)
3. Save the canvas
4. Clear the canvas or reload the page
5. Load the saved canvas
6. **Expected Result**: Device should show the same Cisco icon, not the generic router icon

### Test Scenario 2: Multiple Load/Clear Cycles
1. Load a canvas with devices
2. Clear the canvas
3. Load a different canvas
4. **Expected Result**: Each device should show its correct template icon

### Console Output to Look For

When loading a canvas, you should see:
```
üîÑ Loading canvas from database... <canvasId>
‚úÖ Current devices cleared
üßπ Clearing device icon map (devices cleared)
‚úÖ Canvas data loaded: <canvas>
üîç DEBUG: Devices being loaded from canvas: [...]
‚úÖ Devices loaded from canvas data: <count>
üîç Loading icon for device: <name> {...}
‚úÖ Using template icon for device: <name> from platform: <id> or model: <model>
```

If you see `‚ö†Ô∏è No template icon found` or `üîÑ Using fallback hardcoded icon`, check:
- Device properties were saved correctly
- `platform_id` and `device_type_model` are in the properties JSON
- Template service has the icon for that platform/model

## Related Files

- `frontend/src/components/NOCCanvas.vue`: Main canvas component with device rendering and icon caching
- `frontend/src/composables/useCanvasState.ts`: Canvas save/load logic
- `frontend/src/stores/devices.ts`: Device store with clearDevices()
- `frontend/src/services/templateService.ts`: Template icon retrieval service

## Future Improvements

1. **Icon Cache Persistence**: Consider persisting the icon cache to localStorage to avoid re-downloading icons on page reload
2. **Preloading**: Pre-load template icons when fetching the canvas to reduce visual flicker
3. **Icon Versioning**: Add version tracking to icon cache to invalidate old icons when templates are updated
4. **Bulk Loading**: Batch icon requests to reduce API calls when loading canvases with many devices

## Date
October 7, 2025
